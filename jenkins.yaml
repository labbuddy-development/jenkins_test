#cloud-config
package_update: true
packages:
  - openjdk-21-jdk
  - curl
  - wget

runcmd:
  # Add Jenkins GPG key and repo
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://pkg.jenkins.io/debian/jenkins.io-2023.key | tee /etc/apt/keyrings/jenkins-keyring.asc > /dev/null
  - echo "deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/" > /etc/apt/sources.list.d/jenkins.list
  - apt update
  - apt install -y jenkins
  - apt install -y python3 python3-pip python3-venv


  # Disable Jenkins setup wizard
  - echo 'JAVA_ARGS="-Djenkins.install.runSetupWizard=false"' > /etc/default/jenkins

  # Create Groovy script for admin user
  - mkdir -p /var/lib/jenkins/init.groovy.d
  - |
    cat <<'EOF' > /var/lib/jenkins/init.groovy.d/basic-security.groovy
    #!groovy
    import jenkins.model.*
    import hudson.security.*
    def instance = Jenkins.getInstance()
    def hudsonRealm = new HudsonPrivateSecurityRealm(false)
    hudsonRealm.createAccount("admin", "labuddy@123")
    instance.setSecurityRealm(hudsonRealm)
    def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
    strategy.setAllowAnonymousRead(false)
    instance.setAuthorizationStrategy(strategy)
    instance.setInstallState(jenkins.install.InstallState.INITIAL_SETUP_COMPLETED)
    instance.save()
    EOF

  - |
    cat <<'EOF' > /var/lib/jenkins/init.groovy.d/disable-csrf.groovy
    #!groovy
    import jenkins.model.*
    import hudson.security.csrf.DefaultCrumbIssuer

    def instance = Jenkins.getInstance()
    instance.setCrumbIssuer(null) // Disable CSRF protection
    instance.save()
    EOF

  - chown -R jenkins:jenkins /var/lib/jenkins


  - chown -R jenkins:jenkins /var/lib/jenkins

  # Start Jenkins
  - systemctl restart jenkins
  - sleep 60

  # Download Jenkins CLI
  - wget http://localhost:8080/jnlpJars/jenkins-cli.jar -O /tmp/jenkins-cli.jar

  # Create plugin list
  - |
    cat <<EOF > /tmp/plugins.txt
    antisamy-markup-formatter
    git
    ldap
    mailer
    matrix-auth
    pam-auth
    pipeline-model-definition
    pipeline-stage-view
    pipeline-github-lib
    ssh-slaves
    timestamper
    email-ext
    workflow-aggregator
    workflow-job
    github-branch-source
    gradle
    ant
    dark-theme
    ws-cleanup
    cloudbees-folder
    EOF

  # Install plugins using CLI
  - |
    for plugin in $(cat /tmp/plugins.txt); do
      java -jar /tmp/jenkins-cli.jar -s http://localhost:8080 -auth admin:labuddy@123 install-plugin $plugin
    done

  # Final Jenkins restart
  - systemctl restart jenkins
